name: CI/CD Deploy

on:
  push:
    branches: [develop] #devì— push ë  ë•Œ ë§ˆë‹¤ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest #GitHubì—ì„œ ì œê³µí•˜ëŠ” ubuntu-latestì—ì„œ ì‹¤í–‰

    steps:
      - name: Checkout repository #ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ runnerë¡œ ê°€ì ¸ì˜´
        uses: actions/checkout@v4

      - name: Set up Docker Buildx #ë„ì»¤ setup
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/hanihome-server:latest

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e  # ğŸ›‘ ëª…ë ¹ì–´ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨ ì‹œ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨ë˜ê²Œ ì„¤ì •
            
            echo "[ì‹œì‘] Docker ë””ìŠ¤í¬ ì •ë¦¬ ì¤‘..."
            sudo docker system prune -f  # volumeì€ ìœ ì§€ë¨
            
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/hanihome-server:latest
            sudo docker-compose down
            sudo docker-compose up -d
          
            echo "[ì„±ê³µ] ë°°í¬ ì™„ë£Œ ğŸ‰"
